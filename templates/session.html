<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Pomodoro ì„¸ì…˜ ì„¤ì •</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        /* ìƒˆë¡œìš´ ì œì•ˆ ë°•ìŠ¤ë¥¼ ìœ„í•œ ìŠ¤íƒ€ì¼ */
        .suggestion-box {
            background-color: #f0f8ff; /* ì—°í•œ í•˜ëŠ˜ìƒ‰ ë°°ê²½ */
            border: 1px solid #cceeff; /* ì—°í•œ íŒŒë€ìƒ‰ í…Œë‘ë¦¬ */
            border-radius: 8px;
            padding: 15px 20px;
            margin-top: 20px;
            margin-bottom: 30px; /* START ë²„íŠ¼ ìœ„ ê³µê°„ í™•ë³´ */
            text-align: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        .suggestion-box p {
            margin: 5px 0;
            font-size: 1.1em;
            color: #333;
        }
        .suggestion-box strong {
            color: #007bff; /* íŒŒë€ìƒ‰ ê°•ì¡° */
        }
        .suggestion-header {
            font-size: 1.2em;
            font-weight: bold;
            color: #0056b3;
            margin-bottom: 10px;
        }

        /* ë³€ê²½ëœ ë ˆì´ì•„ì›ƒ ìŠ¤íƒ€ì¼ */
        .session-wrapper {
            display: flex;
            flex-direction: column; /* ì „ì²´ ìš”ì†Œë¥¼ ì„¸ë¡œë¡œ ì •ë ¬ */
            gap: 20px; /* ê° ì„¹ì…˜ ê°„ì˜ ê°„ê²© */
            width: 90%;
            max-width: 600px; /* í¼ ë„ˆë¹„ ì œí•œ */
            margin: 50px auto; /* ì¤‘ì•™ ì •ë ¬ */
            background-color: #fff;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .left-box, .right-box {
            display: flex;
            flex-direction: column; /* ê¸°ë³¸ì€ ì„¸ë¡œ ì •ë ¬ */
            gap: 20px; /* ê·¸ë£¹ ê°„ ê°„ê²© */
        }

        /* 0. ëª©í‘œ ìƒìœ„ ì¹´í…Œê³ ë¦¬ - ë¼ë””ì˜¤ ë²„íŠ¼ ê·¸ë£¹ì„ í•œ ì¤„ë¡œ */
        .category-radio-group {
            display: flex;
            flex-wrap: wrap; /* ë‚´ìš©ì´ ë„˜ì¹˜ë©´ ë‹¤ìŒ ì¤„ë¡œ */
            gap: 15px; /* ë¼ë””ì˜¤ ë²„íŠ¼ ê°„ ê°„ê²© */
            justify-content: center; /* ê°€ìš´ë° ì •ë ¬ (ì„ íƒ ì‚¬í•­) */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .category-radio-group label {
            display: flex;
            align-items: center;
            white-space: nowrap; /* ì¤„ë°”ê¿ˆ ë°©ì§€ */
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 5px;
            transition: background-color 0.2s;
        }
        .category-radio-group label:hover {
            background-color: #e0e0e0;
        }
        .category-radio-group input[type="radio"] {
            margin-right: 8px;
            transform: scale(1.2); /* ë¼ë””ì˜¤ ë²„íŠ¼ í¬ê¸° ì¡°ì ˆ */
        }

        /* ì§‘ì¤‘ ì‹œê°„, íœ´ì‹ ì‹œê°„, ë°˜ë³µ íšŸìˆ˜ë¥¼ í•œ ì¤„ë¡œ */
        .pomodoro-settings-row {
            display: flex;
            flex-wrap: wrap; /* í™”ë©´ì´ ì‘ì•„ì§€ë©´ ì¤„ë°”ê¿ˆ */
            gap: 15px; /* ì„¤ì • í•­ëª© ê°„ ê°„ê²© */
            justify-content: space-around; /* í•­ëª©ë“¤ì„ ê· ë“±í•˜ê²Œ ë¶„ë°° */
            align-items: flex-end; /* í•­ëª©ë“¤ì„ í•˜ë‹¨ì— ì •ë ¬ */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background-color: #f9f9f9;
        }
        .pomodoro-settings-row .form-group {
            flex: 1; /* ê³µê°„ì„ ê· ë“±í•˜ê²Œ ë¶„ë°° */
            min-width: 100px; /* ìµœì†Œ ë„ˆë¹„ */
            max-width: 150px; /* ìµœëŒ€ ë„ˆë¹„ */
            text-align: center;
        }
        .pomodoro-settings-row select {
            width: 100%; /* ë¶€ëª¨ì— ë§ì¶° ë„ˆë¹„ ì¡°ì ˆ */
            padding: 8px;
            border-radius: 5px;
            border: 1px solid #ccc;
        }
        .pomodoro-settings-row label {
            font-weight: bold;
            margin-bottom: 5px;
            display: block; /* ë¼ë²¨ì´ í•œ ì¤„ ì „ì²´ë¥¼ ì°¨ì§€í•˜ë„ë¡ */
        }
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ccc;
            font-size: 1em;
            box-sizing: border-box; /* íŒ¨ë”©ì´ ë„ˆë¹„ì— í¬í•¨ë˜ë„ë¡ */
            resize: vertical; /* ì„¸ë¡œ ë°©í–¥ìœ¼ë¡œë§Œ í¬ê¸° ì¡°ì ˆ ê°€ëŠ¥ */
        }
        .form-group label {
            margin-bottom: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-session">

    {% if bgm != 'off' %}
    <audio id="bgmPlayer" autoplay loop>
        <source src="{{ url_for('static', filename='bgm/' + bgm) }}" type="audio/mpeg">
    </audio>
    {% endif %}

    <form method="post" action="/start">
        <div class="session-wrapper">
            {# ëª©í‘œ ìƒìœ„ ì¹´í…Œê³ ë¦¬ #}
            <div class="form-group">
                <label>0. ëª©í‘œ ìƒìœ„ ì¹´í…Œê³ ë¦¬</label>
                <div class="category-radio-group" id="task_category_radios"> {# idë¥¼ divë¡œ ì´ë™í•˜ì—¬ ë¼ë””ì˜¤ ë²„íŠ¼ ê·¸ë£¹ ì „ì²´ë¥¼ ëŒ€í‘œ #}
                    <label><input type="radio" name="task_category" value="ê³µë¶€/ì´í•´" {% if task_category == 'ê³µë¶€/ì´í•´' %}checked{% endif %} required> ğŸ§  ê³µë¶€/ì´í•´</label>
                    <label><input type="radio" name="task_category" value="ìƒì‚°/ì‘ì„±" {% if task_category == 'ìƒì‚°/ì‘ì„±' %}checked{% endif %} required> âœï¸ ìƒì‚°/ì‘ì„±</label>
                    <label><input type="radio" name="task_category" value="ì½ê¸°/ìë£Œ ìŠµë“" {% if task_category == 'ì½ê¸°/ìë£Œ ìŠµë“' %}checked{% endif %} required> ğŸ“š ì½ê¸°/ìë£Œ ìŠµë“</label>
                    <label><input type="radio" name="task_category" value="ì •ë¦¬/ê´€ë¦¬" {% if task_category == 'ì •ë¦¬/ê´€ë¦¬' %}checked{% endif %} required> ğŸ§¹ ì •ë¦¬/ê´€ë¦¬</label>
                    <label><input type="radio" name="task_category" value="ê¸°íš/ì„¤ê³„" {% if task_category == 'ê¸°íš/ì„¤ê³„' %}checked{% endif %} required> ğŸ¯ ê¸°íš/ì„¤ê³„</label>
                    <label><input type="radio" name="task_category" value="ë¯¸ë¶„ë¥˜" {% if task_category == 'ë¯¸ë¶„ë¥˜' or task_category == '' %}checked{% endif %} required> ğŸ“ ë¯¸ë¶„ë¥˜</label>
                </div>
            </div>
            
            {# ì´ë²ˆ ì‘ì—…ì˜ í•µì‹¬ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”? #}
            <div class="form-group">
                <label for="task">1. ì´ë²ˆ ì‘ì—…ì˜ í•µì‹¬ ëª©í‘œëŠ” ë¬´ì—‡ì¸ê°€ìš”?</label> {# ë¼ë²¨ í…ìŠ¤íŠ¸ ë³€ê²½ #}
                <textarea name="task" id="task" rows="2" required>{{ task or '' }}</textarea>
            </div>

            {# 2ë²ˆ, 3ë²ˆ í•­ëª©ì€ ì œê±°ë˜ì—ˆìŒ #}
            {# focusUnits ê°’ì€ hidden inputìœ¼ë¡œ ìœ ì§€í•˜ì—¬ ì„œë²„ë¡œ ì „ì†¡ (recorder.py í˜¸í™˜ì„±) #}
            <input type="hidden" name="focusUnits" id="focusUnits" value="1"> {# ê¸°ë³¸ê°’ 1ë¡œ ê³ ì • #}

            {# í¬ëª¨ë„ë¡œ ì‹œê°„ ì„¤ì • #}
            <label style="font-weight: bold; font-size: 1.1em; margin-bottom: 10px;">í¬ëª¨ë„ë¡œ ì‹œê°„ ì„¤ì •</label>
            <div class="pomodoro-settings-row"> {# ìƒˆë¡œìš´ Flexbox ì»¨í…Œì´ë„ˆ #}
                <div class="form-group">
                    <label for="workMinutes">ì§‘ì¤‘ ì‹œê°„</label>
                    <select name="workMinutes" id="workMinutes" required>
                        {% for i in range(5, 60, 5) %}
                        <option value="{{ i }}" {% if i == 25 %}selected{% endif %}>{{ i }}ë¶„</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="breakMinutes">íœ´ì‹ ì‹œê°„</label>
                    <select name="breakMinutes" id="breakMinutes" required>
                        {% for i in range(1, 11) %}
                        <option value="{{ i }}" {% if i == 5 %}selected{% endif %}>{{ i }}ë¶„</option>
                        {% endfor %}
                    </select>
                </div>

                <div class="form-group">
                    <label for="repeatCount">ë°˜ë³µ íšŸìˆ˜</label>
                    <select name="repeatCount" id="repeatCount" required>
                        {% for i in range(1, 6) %}
                        <option value="{{ i }}" {% if i == 1 %}selected{% endif %}>{{ i }}íšŒ</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            {# ë°°ê²½ ìŒì•… #}
            <div class="form-group" style="margin-top: 20px;">
                <label for="bgmSelect">ë°°ê²½ ìŒì•…</label>
                <select name="bgm" id="bgmSelect" style="width: 160px;">
                    <option value="off" {% if bgm == 'off' %}selected{% endif %}>Off</option>
                    <option value="rain.mp3" {% if bgm == 'rain.mp3' %}selected{% endif %}>Rain</option>
                    <option value="ocean.mp3" {% if bgm == 'ocean.mp3' %}selected{% endif %}>Ocean</option>
                    <option value="heater.mp3" {% if bgm == 'heater.mp3' %}selected{% endif %}>Heater</option>
                </select>
            </div>
        </div>

        <!-- ìƒˆë¡œ ì¶”ê°€ëœ ì œì•ˆ í‘œì‹œ ì˜ì—­ -->
        <div class="suggestion-box" id="pomodoroSuggestion">
            <p class="suggestion-header">ğŸ’¡ ê³¼ê±° ê¸°ë¡ ê¸°ë°˜ í¬ëª¨ë„ë¡œ ì„¤ì • ì œì•ˆ</p>
            <p id="suggestionContent">ìƒˆë¡œìš´ ë½€ëª¨ë„ë¡œ ì„¸ì…˜ì„ ìœ„í•œ ìµœì ì˜ ì„¤ì •ì„ ì°¾ì•„ë³´ì„¸ìš”! <br>ì¹´í…Œê³ ë¦¬ì™€ ì‘ì—…ëª…ì„ ì…ë ¥í•˜ë©´ ê³¼ê±° ê¸°ë¡ ê¸°ë°˜ ì œì•ˆì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. âœ¨</p>
        </div>

        <div class="start-button-wrapper">
            <button type="submit" class="start-button">START</button>
        </div>
    </form>

    <script>
        const taskCategoryRadios = document.querySelectorAll('input[name="task_category"]');
        const taskTextarea = document.getElementById('task');
        const workMinutesSelect = document.getElementById('workMinutes');
        const breakMinutesSelect = document.getElementById('breakMinutes');
        const repeatCountSelect = document.getElementById('repeatCount');
        const focusUnitsInput = document.getElementById('focusUnits');
        const suggestionContent = document.getElementById('suggestionContent');

        let debounceTimer;

        // ì œì•ˆì„ ê°€ì ¸ì˜¤ëŠ” í•¨ìˆ˜
        async function fetchSuggestions() {
            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
                const category = document.querySelector('input[name="task_category"]:checked')?.value || '';
                const task = taskTextarea.value.trim();

                if (!category || !task) { 
                    suggestionContent.innerHTML = 'ìƒˆë¡œìš´ ë½€ëª¨ë„ë¡œ ì„¸ì…˜ì„ ìœ„í•œ ìµœì ì˜ ì„¤ì •ì„ ì°¾ì•„ë³´ì„¸ìš”! <br>ì¹´í…Œê³ ë¦¬ì™€ ì‘ì—…ëª…ì„ ì…ë ¥í•˜ë©´ ê³¼ê±° ê¸°ë¡ ê¸°ë°˜ ì œì•ˆì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. âœ¨';
                    return;
                }

                try {
                    suggestionContent.innerHTML = 'ì œì•ˆì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤...';
                    
                    const response = await fetch(`/api/suggest_pomodoro?category=${encodeURIComponent(category)}&task=${encodeURIComponent(task)}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    const data = await response.json();

                    const suggestions = data.suggestions;
                    const status = data.status;
                    const reason = data.reason || ''; 

                    let messageHtml = '';
                    if (status === "openai_success") {
                        messageHtml = `
                            ì´ì „ ì„¸ì…˜ë“¤ì„ ë³´ë‹ˆ, ì´ ì‘ì—…ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì€ ì„¤ì •ì´ <strong>ì ì ˆí•©ë‹ˆë‹¤</strong>:<br>
                            <strong>ì§‘ì¤‘ ì‹œê°„: ${suggestions.workMinutes}ë¶„</strong>,
                            <strong>íœ´ì‹ ì‹œê°„: ${suggestions.breakMinutes}ë¶„</strong>,
                            <strong>ë°˜ë³µ íšŸìˆ˜: ${suggestions.repeatCount}íšŒ</strong><br>
                            <small>${reason}</small>
                        `;
                    } else if (status === "invalid_input" || status === "openai_fallback_low_records") {
                        messageHtml = `
                            <span style="color:orange; font-weight:bold;">${reason}</span><br>
                            <strong>ì§‘ì¤‘ ì‹œê°„: ${suggestions.workMinutes}ë¶„</strong>,
                            <strong>íœ´ì‹ ì‹œê°„: ${suggestions.breakMinutes}ë¶„</strong>,
                            <strong>ë°˜ë³µ íšŸìˆ˜: ${suggestions.repeatCount}íšŒ</strong><br>
                        `;
                    }
                    else if (status === "openai_fallback" || status === "openai_error" || status === "openai_api_error") {
                        messageHtml = `
                            ì•„ì§ ì´ ì‘ì—…ì— ëŒ€í•œ ì¶©ë¶„í•œ ê¸°ë¡ì´ ì—†ê±°ë‚˜, ì¸ê³µì§€ëŠ¥ì´ ë¶„ì„í•˜ê¸° ì–´ë ¤ì›Œ ì¼ë°˜ì ì¸ ì¶”ì²œ ì„¤ì •ì„ ì œì•ˆí•©ë‹ˆë‹¤.<br>
                            ì„¸ì…˜ ê¸°ë¡ì´ ìŒ“ì¼ìˆ˜ë¡ ë”ìš± ì •êµí•œ ë§ì¶¤ ì œì•ˆì„ ë°›ì„ ìˆ˜ ìˆì–´ìš”! ğŸ’¡<br>
                            <strong>ì§‘ì¤‘ ì‹œê°„: ${suggestions.workMinutes}ë¶„</strong>,
                            <strong>íœ´ì‹ ì‹œê°„: ${suggestions.breakMinutes}ë¶„</strong>,
                            <strong>ë°˜ë³µ íšŸìˆ˜: ${suggestions.repeatCount}íšŒ</strong><br>
                            <small>${reason}</small>
                        `;
                    } else if (status === "api_key_missing") {
                         messageHtml = `
                            <span style="color:red; font-weight:bold;">ì˜¤ë¥˜: OpenAI API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.</span><br>
                            <small>${reason}</small>
                         `;
                    }
                    
                    suggestionContent.innerHTML = messageHtml;

                    workMinutesSelect.value = suggestions.workMinutes;
                    breakMinutesSelect.value = suggestions.breakMinutes;
                    repeatCountSelect.value = suggestions.repeatCount;
                    focusUnitsInput.value = suggestions.focusUnits;

                } catch (error) {
                    console.error('Failed to fetch suggestions:', error);
                    suggestionContent.innerHTML = 'ì œì•ˆì„ ê°€ì ¸ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. (ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë˜ëŠ” ì„œë²„ ì‘ë‹µ ë¬¸ì œ)';
                }
            }, 500); // 0.5ì´ˆ ë””ë°”ìš´ìŠ¤
        }

        taskCategoryRadios.forEach(radio => {
            radio.addEventListener('change', fetchSuggestions);
        });
        taskTextarea.addEventListener('input', fetchSuggestions);

        document.addEventListener('DOMContentLoaded', () => {
            const initialCategory = document.querySelector('input[name="task_category"]:checked')?.value || '';
            const initialTask = taskTextarea.value.trim();
            
            if (initialCategory && initialTask) {
                fetchSuggestions();
            } else {
                suggestionContent.innerHTML = 'ìƒˆë¡œìš´ ë½€ëª¨ë„ë¡œ ì„¸ì…˜ì„ ìœ„í•œ ìµœì ì˜ ì„¤ì •ì„ ì°¾ì•„ë³´ì„¸ìš”! <br>ì¹´í…Œê³ ë¦¬ì™€ ì‘ì—…ëª…ì„ ì…ë ¥í•˜ë©´ ê³¼ê±° ê¸°ë¡ ê¸°ë°˜ ì œì•ˆì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. âœ¨';
            }

            const lastBgm = "{{ bgm }}";
            const bgmSelect = document.getElementById('bgmSelect');
            if (lastBgm && bgmSelect) {
                bgmSelect.value = lastBgm;
            }

            const initialTaskCategory = "{{ task_category }}";
            if (initialTaskCategory) {
                const initialCategoryRadio = document.querySelector(`input[name="task_category"][value="${initialTaskCategory}"]`);
                if (initialCategoryRadio) {
                    initialCategoryRadio.checked = true;
                }
            } else {
                document.querySelector('input[name="task_category"][value="ë¯¸ë¶„ë¥˜"]').checked = true;
            }
        });

    </script>
</body>
</html>
