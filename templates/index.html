<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Pomodoro Web</title>
    <style>
        body {
            font-family: Arial;
            text-align: center;
            margin: 40px;
        }
        .section {
            margin: 15px 0;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <h1>Pomodoro Timer</h1>

    <div id="settings">
        <div class="section">
            <label>Work (min): <input type="number" id="workMinutes" value="25"></label>
            <label>Break (min): <input type="number" id="breakMinutes" value="5"></label>
            <label>Repeat count (1~5): <input type="number" id="repeatCount" value="1" min="1" max="5"></label>
        </div>

        <div class="section">
            <strong>Focus Level:</strong><br>
            <label><input type="radio" name="focus" value="High"> High</label>
            <label><input type="radio" name="focus" value="Medium" checked> Medium</label>
            <label><input type="radio" name="focus" value="Low"> Low</label>
        </div>

        <div class="section">
            <strong>Work Flow:</strong><br>
            <label><input type="radio" name="flow" value="Fast" checked> Fast</label>
            <label><input type="radio" name="flow" value="Relaxed"> Relaxed</label>
            <label><input type="radio" name="flow" value="Find Rhythm"> Find Rhythm</label>
        </div>

        <div class="section">
            <strong>Task Type:</strong><br>
            <label><input type="radio" name="task" value="Writing" checked> Writing</label>
            <label><input type="radio" name="task" value="Repetitive Task"> Repetitive Task</label>
            <label><input type="radio" name="task" value="Creative Thinking"> Creative Thinking</label>
        </div>

        <div class="section">
            <label><input type="checkbox" id="alarmToggle" checked> Enable Alarm Sound</label>
        </div>
    </div>

    <div class="section">
        <h2 id="timer">25:00</h2>
        <button onclick="startPomodoro()">Start</button>
        <button onclick="pausePomodoro()" id="pauseBtn" class="hidden">Pause</button>
        <button onclick="stopPomodoro()" id="stopBtn" class="hidden">Stop</button>
    </div>

    <audio id="alarmSound" src="/static/alarm.mp3" preload="auto"></audio>

    <script>
        let isWork = true;
        let interval;
        let totalRepeats = 1;
        let currentRepeat = 0;
        let isPaused = false;

        function getRadioValue(name) {
            const radios = document.getElementsByName(name);
            for (const radio of radios) {
                if (radio.checked) return radio.value;
            }
            return "";
        }

        function startPomodoro() {
            const workMinutes = parseInt(document.getElementById("workMinutes").value) || 25;
            const breakMinutes = parseInt(document.getElementById("breakMinutes").value) || 5;
            totalRepeats = parseInt(document.getElementById("repeatCount").value) || 1;

            const focus = getRadioValue("focus");
            const flow = getRadioValue("flow");
            const task = getRadioValue("task");

            hideSettings();
            isWork = true;
            currentRepeat = 0;

            const durations = {
                work: workMinutes * 60,
                break: breakMinutes * 60
            };//시간관리

            function runTimer(duration) {
                let timeLeft = duration;
                updateTimerDisplay(timeLeft);
                document.body.style.backgroundColor = isWork ? "#FF6347" : "#4CAF50";

                clearInterval(interval);
                interval = setInterval(() => {
                    if (!isPaused) {
                        timeLeft--;
                        updateTimerDisplay(timeLeft);
                        if (timeLeft <= 0) {
                            clearInterval(interval);

                            // ?븣?엺: 吏묒쨷?떆媛? 醫낅즺 ?떆留? ?떎?뻾
                            if (isWork && document.getElementById("alarmToggle").checked) {
                                document.getElementById("alarmSound").play();
                            }

                            if (!isWork) currentRepeat++;
                            if (currentRepeat < totalRepeats) {
                                isWork = !isWork;
                                runTimer(isWork ? durations.work : durations.break);
                            } else {
                                saveRecord(focus, flow, task);
                                alert("Pomodoro session complete!");
                                resetUI();
                            }
                        }
                    }
                }, 1000);
            }

            runTimer(durations.work);
        }

        function pausePomodoro() {
            isPaused = !isPaused;
            document.getElementById("pauseBtn").textContent = isPaused ? "Resume" : "Pause";
        }

        function stopPomodoro() {
            clearInterval(interval);
            resetUI();
        }

        function resetUI() {
            document.body.style.backgroundColor = "#ffffff";
            showSettings();
            updateTimerDisplay(0);
            isPaused = false;
        }

        function updateTimerDisplay(seconds) {
            const m = String(Math.floor(seconds / 60)).padStart(2, "0");
            const s = String(seconds % 60).padStart(2, "0");
            document.getElementById("timer").textContent = `${m}:${s}`;
        }

        function hideSettings() {
            document.getElementById("settings").classList.add("hidden");
            document.getElementById("pauseBtn").classList.remove("hidden");
            document.getElementById("stopBtn").classList.remove("hidden");
        }

        function showSettings() {
            document.getElementById("settings").classList.remove("hidden");
            document.getElementById("pauseBtn").classList.add("hidden");
            document.getElementById("stopBtn").classList.add("hidden");
            document.getElementById("pauseBtn").textContent = "Pause";
        }

        function saveRecord(focus, flow, task) {
            fetch("/save_record", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({ focus, flow, task, timestamp: new Date().toISOString() })
            });
        }
    </script>
</body>
</html>
