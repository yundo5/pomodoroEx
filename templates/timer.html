<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>Pomodoro 타이머</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body class="timer-page">
  <div class="wrapper">
    <div id="main-body">
      <div id="timerDisplay">준비 중...</div>
    </div>

    <div class="bottom-options">
      <button id="backButton">← 뒤로가기</button>

      <label class="checkbox-label">
        <input type="checkbox" id="bgToggle" checked />
        배경 애니메이션 ON
      </label>

      <div class="volume-control">
        <label for="volumeRange">배경음악</label>
        <input type="range" id="volumeRange" min="0" max="100" value="100" />
      </div>

      <div class="repeat-control-box">
        <button id="minusRepeat" class="repeat-btn">−</button>
        <span id="repeatCountDisplay"></span>
        <button id="plusRepeat" class="repeat-btn">＋</button>
      </div>

      <div class="control-buttons">
        <button id="pauseBtn" class="flat-button pause-button" onclick="togglePause()">⏸ 일시정지</button>
        <button class="flat-button stop-button" onclick="stopTimer()">⏹ 종료하기</button>
      </div>
    </div>
  </div>

  <audio id="bgMusic" loop></audio>

  <script>
    // 서버에서 전달된 설정값
    const selectedMusic  = "{{ session.get('bgm', 'off') }}";
    const workMinutes    = parseInt("{{ session['workMinutes'] }}");
    const breakMinutes   = parseInt("{{ session['breakMinutes'] }}");
    let maxpomocount     = parseInt("{{ session['repeatCount'] }}") || 1;
    let pomocount        = 0;

    // 상태 변수
    let isBreak               = false;
    let isPaused              = false;
    let interval              = null;
    let seconds               = workMinutes * 60;
    let bgIndex               = 1;
    let currentThemeIndex     = 0;
    const themes              = ["땅","산","하늘","성층권","우주"];
    const totalImages         = 12;
    let currentTheme          = themes[currentThemeIndex];
    let backgroundAnimationOff= false;

    // DOM 요소
    const display       = document.getElementById("timerDisplay");
    const pauseBtn      = document.getElementById("pauseBtn");
    const bodyElem      = document.getElementById("main-body");
    const bgToggle      = document.getElementById("bgToggle");
    const bgMusic       = document.getElementById("bgMusic");
    const volumeRange   = document.getElementById("volumeRange");
    const repeatDisplay = document.getElementById("repeatCountDisplay");
    const plusBtn       = document.getElementById("plusRepeat");
    const minusBtn      = document.getElementById("minusRepeat");

    // 초기 반복 횟수 표시
    repeatDisplay.textContent = maxpomocount;

    // 반복 횟수 조절
    plusBtn.addEventListener("click", () => {
      maxpomocount++;
      repeatDisplay.textContent = maxpomocount;
    });
    minusBtn.addEventListener("click", () => {
      if (maxpomocount > 1) {
        maxpomocount--;
        repeatDisplay.textContent = maxpomocount;
      }
    });

    // 배경 애니메이션 토글
    bgToggle.addEventListener("change", () => {
      backgroundAnimationOff = !bgToggle.checked;
      applyBackground();
    });

    // 볼륨 조절
    volumeRange.addEventListener("input", () => {
      bgMusic.volume = volumeRange.value / 100;
    });

    // 뒤로가기
    document.getElementById("backButton").addEventListener("click", () => {
      window.location.href = "/session";
    });

    function updateDisplay() {
      const m = Math.floor(seconds / 60);
      const s = seconds % 60;
      display.textContent = `${m}분 ${s < 10 ? "0"+s : s}초`;
    }

    function preloadAndSetBackground(src) {
      const img = new Image();
      img.onload = () => {
        bodyElem.style.backgroundImage = `url('${src}')`;
        bodyElem.style.backgroundColor = "";
      };
      img.src = src;
    }

    function applyBackground() {
      if (backgroundAnimationOff) {
        bodyElem.style.backgroundImage = "none";
        bodyElem.style.backgroundColor = isBreak ? "red" : "green";
      } else {
        changeBackground();
      }
    }

    function changeBackground() {
      if (backgroundAnimationOff) return;
      const path = isBreak
        ? `/static/images/나무/${currentTheme}/${currentTheme}-휴식시간.png`
        : `/static/images/나무/${currentTheme}/${currentTheme}-나무${bgIndex}.png`;
      preloadAndSetBackground(path);
      if (!isBreak) {
        bgIndex++;
        if (bgIndex > totalImages) {
          bgIndex = 1;
          currentThemeIndex = (currentThemeIndex + 1) % themes.length;
          currentTheme = themes[currentThemeIndex];
        }
      }
    }

    function startBackgroundRotation() {
      changeBackground();
      setInterval(() => {
        if (!isPaused && !backgroundAnimationOff) {
          changeBackground();
        }
      }, 300000);
    }

    function playBackgroundMusic() {
      if (selectedMusic && selectedMusic !== "off") {
        bgMusic.src = `/static/music/${selectedMusic}`;
        bgMusic.play().catch(err => console.log("자동재생 차단:", err));
      }
    }

    function startTimer() {
      updateDisplay();
      playBackgroundMusic();
      interval = setInterval(() => {
        if (isPaused) return;

        if (seconds > 0) {
          seconds--;
          updateDisplay();
        } else {
          if (!isBreak) {
            // 집중 → 휴식
            isBreak = true;
            seconds = breakMinutes * 60;
            applyBackground();
            updateDisplay();
          } else {
            // 휴식 종료
            pomocount++;
            if (pomocount < maxpomocount) {
              // 다음 집중 세션
              isBreak = false;
              seconds = workMinutes * 60;
              applyBackground();
              updateDisplay();
            } else {
              // 반복 완료 → 피드백 페이지
              clearInterval(interval);
              bgMusic.pause();
              bgMusic.currentTime = 0;
              const qs = new URLSearchParams({
                workMinutes: workMinutes,
                breakMinutes: breakMinutes,
                repeatCount: maxpomocount,
                task: "{{ session['task'] }}",
                goal: "{{ session['goal'] }}"
              });
              window.location.href = "/feedback?" + qs.toString();
            }
          }
        }
      }, 1000);
    }

    window.togglePause = function() {
      isPaused = !isPaused;
      pauseBtn.textContent = isPaused ? "▶ 재개" : "⏸ 일시정지";
      applyBackground();
      if (isPaused) bgMusic.pause();
      else playBackgroundMusic();
    };

    window.stopTimer = function() {
      clearInterval(interval);
      bgMusic.pause();
      bgMusic.currentTime = 0;
      window.location.href = "/feedback";
    };

    // 초기 실행
    startBackgroundRotation();
    startTimer();
  </script>
</body>
</html>
